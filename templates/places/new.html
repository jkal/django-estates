{% extends "base.html" %}

{% block title %}
Add new estate
{% endblock %}

{% block style %}
<script type="text/javascript" src="/static/js/jquery.history.js"></script>
<script type="text/javascript" src="/static/js/jquery.form.js"></script>
<script type="text/javascript" src="/static/js/jquery.validate.js"></script>
<script type="text/javascript" src="/static/js/jquery.form.wizard-2.0.1-min.js"></script>
{% endblock %}

{% block script %}
<script type="text/javascript">
var geocoder;
var map;

function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var myOptions = {
        zoom: 15,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("new-place-map"), myOptions);
}

function codeAddress() {
    var address = $("#id_address").val();
    var city = $("#id_city").val();
    var zipcode = $("#id_zipcode").val();
    var country = $("#id_country").val();
    var fulladdr = address + ', ' + city + ', ' + country;
    
    if (geocoder) {
        geocoder.geocode( { 'address': fulladdr}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                map.setCenter(results[0].geometry.location);
                window.lat = results[0].geometry.location.lat();
                window.lng = results[0].geometry.location.lng();
                $("#id_latitude").attr('value', window.lat); 
                $("#id_longitude").attr('value', window.lng);
                var marker = new google.maps.Marker({
                    map: map, 
                    position: results[0].geometry.location
                });
            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }
}

$(document).ready(function(){
    $("label").inFieldLabels();
    
    $("#new-place-form").formwizard({
        historyEnabled : true, 
        formPluginEnabled: false, 
        validationEnabled : false,
        focusFirstInput : false,     // puts focus at the first input on each step
        afterNext : function(wizardData) {
            if (wizardData.isLastStep) {
                initialize();
                codeAddress();
            }
        },
    }, {
        //validation settings
    }, {
        success: function(data) {   // called when the form has been submitted correctly to the server
            alert("post successful"); 
        },
        beforeSubmit: function(data){   // called just before the form is submitted
        },
        dataType: 'json',
        resetForm: true,
    });
});
</script>
{% endblock %}

{% block content %}

<ul id="posts" >
    <li class="post">
        <h3><a href="" title="">New Place</a></h3>
        <div class="post-content">
            {% include "places/new_form.html" %}
        </div>
    </li>
</ul>

{% endblock %}
