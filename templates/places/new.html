{% extends "base.html" %}

{% block title %}
    New Place
{% endblock %}

{% block style %}
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.history.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.form.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.validate.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.form.wizard-2.0.1-min.js"></script>
{% endblock %}

{% block script %}
<script type="text/javascript">
var geocoder;
var map;

function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(38, 22);
    var myOptions = {
        zoom: 4,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.HYBRID
    };
    map = new google.maps.Map(document.getElementById("new-place-map"), myOptions);
}

function codeAddress() {
    var address = $("#id_address").val();
    var city = $("#id_city").val();
    var zipcode = $("#id_zipcode").val();
    var country = $("#id_country").val();
    var fulladdr = address + ', ' + city + ', ' + country;

    if (address != '' && city != '') {
        if (geocoder) {
            geocoder.geocode( { 'address': fulladdr }, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    $("#map-status").hide();
                    var geolocation = results[0].geometry.location;

                    map.setCenter(geolocation);
                    map.setZoom(15);

                    $("#id_latitude").attr('value', geolocation.lat()); 
                    $("#id_longitude").attr('value', geolocation.lng());
                    var marker = new google.maps.Marker({
                        map: map, 
                        position: results[0].geometry.location
                    });
                } else {
                    $("#map-status").show();
                }
            });
        }
    }
}

$(document).ready(function() {
    
    $('#add-image').click(function() {
        $(this).parent().append('<p><input type="file" name="photo1"></p>');
    });
    
    $("label").inFieldLabels();
    $("#new-place-form").formwizard({
        historyEnabled : true, 
        formPluginEnabled: false, 
        validationEnabled : false,
        focusFirstInput : false,     // puts focus at the first input on each step
        afterNext : function(wizardData) {
            if (wizardData.isLastStep) {
                initialize();
                codeAddress();
            }
        },
    }, {
        //validation settings
    }, {
        success: function(data) {   // called when the form has been submitted correctly to the server
            alert("post successful"); 
        },
        beforeSubmit: function(data){   // called just before the form is submitted
        },
        dataType: 'json',
        resetForm: true,
    });
});
</script>
{% endblock %}

{% block content %}

<ul id="posts" >
    <li class="post">
        <h3>New Place</h3>
        <div class="post-content">
            {% include "places/new_form.html" %}
        </div>
    </li>
</ul>

{% endblock %}
